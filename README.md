![Build Status](https://github.com/EgorDikanskiy/Sparq/actions/workflows/python-package.yml/badge.svg)

Проект использует **Python 3.12.7**.  
Рекомендуется установить окружение с этой версией Python, используя [`pyenv`](https://github.com/pyenv/pyenv) или любую другую систему управления версиями.

Мы используем [Poetry](https://python-poetry.org/) для управления зависимостями.


Установите Poetry
1. `pip install poetry`
Активируйте виртуальное окружение::
2. `poetry shell`
Установите зависимости:
3. `poetry install`
Добавить новую зависимость:
`poetry add <dep_name>`

---

Запуск в DEV-режиме:
### Запуск через Docker Compose

1. Установите Docker

2. Создайте .env файл в корне проекта (по образцу .env.example):

3. Соберите образы:

```bash
docker-compose build
```

```bash
docker-compose up
```
---

## Миграции:
При запуске контейнера существующие миграции накатываются сами. Если вы хотите добавить миграцию

`alembic revision --autogenerate -m "Имя миграции"`
`alembic upgrade head`

## Как это рабоатет?

Сейчас есть 3 важных компонента:
1. В main.py есть WebSocket хэндлер, он принимает сообщения и подключения
2. В модуле ws_handlers, есть обработчики пользовательских сообщений. ws_handler принимает json из webscoket сообщения, и в зависимости от содержания, использует обработчик из ws_handlers.handlers. Важно, что handler никак не взаимодействует с WebSocket соедением.
3. в events_queue - обрабатываеются события связанные с ws подключениями. Отправка сообщений должна происходить тут. 
 - **Зачем это?**
 Отправка сообщений без отдельной очереди будет работать, до тех пор пока не появляется второй сервер/воркер. Напрмер, нам может потребоваться отправить сообщение пользователю, который подключен на другом узле. Для этого в очередь ивентов можно будет отправлять ивент об потребности в отправке данных какому-то пользователю (например с помощью redis или rabbitmq). Например, храним в redis словарь (user_id -> ивент). В очереди оправшиваем redis о новых ивентах для пользователей подключенных на нашем узле, как только в redis появляются eventы, обрабатываем их на нужном узле. 

## Тесты

```bash
docker-compose run tests
```

Создание test-базы будет добавлено позже (см. TODO в docker-compose.yml)


##  Документация API

После запуска проекта перейдите по следующему пути:

- Swagger UI: [http://localhost:8000/docs](http://localhost:8000/docs)
- ReDoc: [http://localhost:8000/redoc](http://localhost:8000/redoc)

FastAPI автоматически создаёт OpenAPI-спецификацию.

